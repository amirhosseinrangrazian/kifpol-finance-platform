{% extends 'base.html' %}
{% load persian_tags %}

{% block title %}گزارشات - کیف‌پول{% endblock %}

{% block content %}
<div class="analytics-page animate-fade-in">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-2">
            <i class="bi bi-activity text-primary fs-4"></i>
            <h4 class="fw-bold mb-0">تحلیل و گزارشات</h4>
        </div>
    </div>

    <!-- Period Filter Buttons -->
    <div class="card mb-4">
        <div class="card-body py-2">
            <div class="d-flex flex-wrap justify-content-center gap-2">
                <button class="btn btn-outline-primary period-btn active" data-period="daily">
                    <i class="bi bi-calendar-day me-1"></i>
                    روزانه
                </button>
                <button class="btn btn-outline-primary period-btn" data-period="weekly">
                    <i class="bi bi-calendar-week me-1"></i>
                    هفتگی
                </button>
                <button class="btn btn-outline-primary period-btn" data-period="monthly">
                    <i class="bi bi-calendar-month me-1"></i>
                    ماهانه
                </button>
                <button class="btn btn-outline-primary period-btn" data-period="yearly">
                    <i class="bi bi-calendar me-1"></i>
                    سالانه
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-4">
            <div class="card bg-success-subtle border-0">
                <div class="card-body text-center py-3">
                    <div class="text-success small">کل درآمد</div>
                    <div class="fw-bold text-success" id="totalIncome">۰</div>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card bg-danger-subtle border-0">
                <div class="card-body text-center py-3">
                    <div class="text-danger small">کل هزینه</div>
                    <div class="fw-bold text-danger" id="totalExpense">۰</div>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card bg-primary-subtle border-0">
                <div class="card-body text-center py-3">
                    <div class="text-primary small">تراز</div>
                    <div class="fw-bold text-primary" id="totalBalance">۰</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Insights -->
    <div class="row g-3 mb-4" id="insightsContainer"></div>

    <!-- Cash Flow Chart -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center gap-2 mb-3">
                <i class="bi bi-bar-chart text-muted"></i>
                <h6 class="mb-0 fw-bold">جریان نقدی (Cash Flow)</h6>
            </div>
            <div style="height: 300px;">
                <canvas id="cashFlowChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Net Worth Chart -->
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <i class="bi bi-graph-up-arrow text-muted"></i>
                        <h6 class="mb-0 fw-bold">رشد سرمایه</h6>
                    </div>
                    <div style="height: 250px;">
                        <canvas id="netWorthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Pie Chart -->
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <i class="bi bi-pie-chart text-muted"></i>
                        <h6 class="mb-0 fw-bold">ترکیب هزینه‌ها</h6>
                    </div>
                    <div style="height: 250px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    var cashFlowChart = null;
    var netWorthChart = null;
    var categoryChart = null;
    var currentPeriod = 'daily';

    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function toPersianDigits(str) {
        var persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        return str.toString().replace(/\d/g, function (d) { return persianDigits[d]; });
    }

    function loadAnalytics(period) {
        currentPeriod = period;

        // Update active button
        document.querySelectorAll('.period-btn').forEach(function (btn) {
            btn.classList.remove('active');
            if (btn.dataset.period === period) {
                btn.classList.add('active');
            }
        });

        fetch('{% url "analytics_data" %}?period=' + period)
            .then(function (res) { return res.json(); })
            .then(function (data) {
                // Update totals
                document.getElementById('totalIncome').textContent = toPersianDigits(formatNumber(Math.round(data.totals.income))) + ' تومان';
                document.getElementById('totalExpense').textContent = toPersianDigits(formatNumber(Math.round(data.totals.expense))) + ' تومان';
                document.getElementById('totalBalance').textContent = toPersianDigits(formatNumber(Math.round(data.totals.balance))) + ' تومان';

                // Destroy existing charts
                if (cashFlowChart) cashFlowChart.destroy();
                if (netWorthChart) netWorthChart.destroy();
                if (categoryChart) categoryChart.destroy();

                // Cash Flow Chart
                if (data.period_data && data.period_data.length > 0) {
                    var ctx1 = document.getElementById('cashFlowChart').getContext('2d');
                    cashFlowChart = new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: data.period_data.map(function (d) { return d.period; }),
                            datasets: [
                                {
                                    label: 'درآمد',
                                    data: data.period_data.map(function (d) { return d.income; }),
                                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                                    borderRadius: 6
                                },
                                {
                                    label: 'هزینه',
                                    data: data.period_data.map(function (d) { return d.expense; }),
                                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                    borderRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                // Net Worth Chart
                if (data.netWorth && data.netWorth.length > 0) {
                    var ctx2 = document.getElementById('netWorthChart').getContext('2d');
                    netWorthChart = new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: data.netWorth.map(function (d) { return d.period; }),
                            datasets: [{
                                label: 'موجودی کل',
                                data: data.netWorth.map(function (d) { return d.value; }),
                                borderColor: '#3f4f28',
                                backgroundColor: 'rgba(63, 79, 40, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }

                // Category Pie Chart
                if (data.categories && data.categories.length > 0) {
                    var ctx3 = document.getElementById('categoryChart').getContext('2d');
                    categoryChart = new Chart(ctx3, {
                        type: 'doughnut',
                        data: {
                            labels: data.categories.map(function (d) { return d.name; }),
                            datasets: [{
                                data: data.categories.map(function (d) { return d.value; }),
                                backgroundColor: [
                                    '#3f4f28', '#556b2f', '#8fbc8f', '#a8a29e',
                                    '#ef4444', '#f59e0b', '#6366f1', '#ec4899'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            },
                            cutout: '60%'
                        }
                    });
                }

                // Generate Insights
                var container = document.getElementById('insightsContainer');
                container.innerHTML = '';

                if (data.period_data && data.period_data.length > 0) {
                    var lastPeriod = data.period_data[data.period_data.length - 1];
                    var savings = lastPeriod.income - lastPeriod.expense;
                    var savingsRate = lastPeriod.income > 0 ? (savings / lastPeriod.income * 100).toFixed(0) : 0;

                    var insights = [];

                    if (savingsRate > 20) {
                        insights.push({
                            icon: 'bi-graph-up',
                            color: 'success',
                            title: 'نرخ پس‌انداز عالی',
                            desc: 'تبریک! شما ' + toPersianDigits(savingsRate) + '٪ از درآمد خود را پس‌انداز کرده‌اید.'
                        });
                    } else if (savings < 0) {
                        insights.push({
                            icon: 'bi-graph-down',
                            color: 'danger',
                            title: 'تراز منفی',
                            desc: 'مراقب باشید! هزینه‌های این دوره از درآمدتان بیشتر است.'
                        });
                    }

                    insights.forEach(function (insight) {
                        container.innerHTML += '<div class="col-12 col-md-6">' +
                            '<div class="card bg-' + insight.color + '-subtle border-0">' +
                            '<div class="card-body d-flex align-items-start gap-3">' +
                            '<div class="bg-white rounded-3 p-2 shadow-sm text-' + insight.color + '">' +
                            '<i class="bi ' + insight.icon + ' fs-4"></i>' +
                            '</div>' +
                            '<div>' +
                            '<h6 class="fw-bold text-' + insight.color + ' mb-1">' + insight.title + '</h6>' +
                            '<p class="small text-muted mb-0">' + insight.desc + '</p>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '</div>';
                    });
                }
            });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        loadAnalytics('daily');

        document.querySelectorAll('.period-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                loadAnalytics(this.dataset.period);
            });
        });
    });
</script>
{% endblock %}